---
title: アイソレーション型（Isolation Pattern）
---

アイソレーション（分離・隔絶）型は、フロントエンドから送信された Tauri API メッセージが Tauri コア部に到達する前に、JavaScript を使用して傍受・変更する方法です。アイソレーション型で挿入される安全な JavaScript コードは、アイソレーション・アプリケーションと呼ばれます。

## アイソレーション型の必要性

アイソレーション型の目的は、Tauri コア部への望ましくないあるいは悪意のあるフロントエンドからの呼び出しから、アプリケーションを保護するためのメカニズムを開発者に提供することです。アイソレーション型の必要性は、フロントエンドで実行されている信頼できないコンテンツから生じる脅威、このような脅威は多くの依存関係を持つアプリケーションによくあるケースですが、そこから生まれました。アプリケーションが遭遇する可能性のある多くの脅威源のリストについては、[セキュリティ：脅威モデル] を参照してください。

アイソレーション型を設計する上で考慮された、上記で記述された最大の脅威モデルは「開発の脅威」でした。多くのフロントエンドのビルド・ツールが、しばしば深くネスト化された数十（もしくは数百）の依存関係で成り立っているだけではなく、複雑なアプリケーションにも、最終出力版にバンドルされる大量の（これも深くネスト化された）依存関係がある場合があります。

## アイソレーション型を使用する局面

Tauri は、アイソレーション型が使用できる場合には常に使用することを強く推奨しています。アイソレーション型のアプリケーションではフロントエンドからの _**すべての**_ メッセージを「捕捉」（インターセプト）するため、アイソレーション型が _常に_ 使用されます。

さらに Tauri では、外部の Tauri API を使用するときは常に、アプリケーションを「封鎖」（ロックダウン）することを強く推奨しています。アプリの開発者は、安全なアイソレーション・アプリケーション（分離アプリケーション）を利用して IPC 入力を検証し、その入力内容が確実に想定されるパラメータの範囲内にあることを確かめます。事例としては、ファイルの読み取りまたは書き込みの呼び出しが、そのアプリケーションの想定外の場所へのパスにアクセスしようとしていないかを確認したり、あるいは、Tauri API の「HTTP フェッチコール」が 「Origin ヘッダー」をそのアプリケーションが想定しているもののみに設定しているかを確認したりすることです。

とはいえ、フロントエンドからの _**すべての**_ メッセージを捕捉するため、[Events] などの常時動作 API でも動作します。一部のイベントでは、アプリ独自の Rust コードにアクションを実行させる可能性があるので、同様の検証手法で対応することができます。

## アイソレーション型の適用

アイソレーション型で重要なのは、フロントエンドと Tauri コアの間に安全なアプリケーションを挿入して、IPC 受信メッセージを捕捉し修正することです。これは、`<iframe>` のサンドボックス機能（隔離機能）を使用して、メインのフロントエンド・アプリケーションと並行して JavaScript を安全に実行することで実現します。Tauri は、ページの読み込み中にアイソレーション型を発動し、Tauri コアに対するすべての IPC 呼び出しを、直接ではなく、サンドボックス化（隔離化）されたアイソレーション・アプリケーション経由で行なうように強制的にルートを切り替えます。Tauri コアに渡されるメッセージの準備が整うと、メッセージはブラウザ実装の [SubtleCrypto] を使用して暗号化され、メインのフロントエンド・アプリケーションに返されます。
フロントエンドに戻されるとすぐに、メッセージは直接 Tauri コアに渡され、そこで通常どおりに復号化されて読み取られます。

誰かがアプリケーションの特定のバージョンのキーを手動で読み取り、暗号化後にそのキーをメッセージの変更に利用できないようにするために、アプリケーションが実行されるたびに新しいキーが生成されます。

### IPC メッセージのおおよその手順

動作の流れを判りやすくするために、アイソレーション型の IPC メッセージが Tauri コアに送信されるときに実行されるおおよその手順を、順序付きリストで以下に示します：

1. Tauri の IPC ハンドラーがメッセージを受け取ります
2. IPC ハンドラー　→　アイソレーション・アプリケーション
3. `[sandbox]`　アイソレーション・アプリケーションのフックが実行され、メッセージの変更を行なう可能性があります。
4. `[sandbox]` メッセージは「実行時に生成されるキー」を使用して AES-GCM で暗号化されます
5. `[encrypted]` アイソレーション・アプリケーション　→　IPC ハンドラー
6. `[encrypted]` IPC ハンドラー　→　Tauri コア

_注記：　矢印（→）は、メッセージ・パッシング（受け渡し）を示します。_

### パフォーマンスへの影響

メッセージの暗号化が行なわれるため、安全なアイソレーション・アプリケーションが何も行なわない場合ですら、[ブラウンフィールド型] と比較して追加のオーバーヘッド・コストが発生します。（適切なパフォーマンスを維持するために、慎重に保守され依存関係も少ないであろう）パフォーマンス重視のアプリケーションを除いて、ほとんどのアプリケーションは比較的小型で AES-GCM も比較的高速であるため、IPC メッセージの暗号化／復号化の実行時コストを意識する必要はありません。もし AES-GCM について馴染みがないとしても、ここで関連するのは、それが [SubtleCrypto] に含まれる唯一の認証モード・アルゴリズムであり、おそらく [TLS][transport_layer_security] の内部で既に毎日使用しているということだけです。

Tauri アプリケーションが起動されるたびに一回、暗号化された安全なキーも生成されますが、システムがすでに十分なエントロピー（ランダム性）を備えていて、即座に十分な乱数を返すのであれば、この処理には通常気付きません。これは「デスクトップ環境」では極めて一般的です。「ヘッドレス環境」で [WebDriver との統合テスト] などを実行する場合で、オペレーティング・システムにエントロピー生成サービス《訳注：　「乱数生成」機能》が含まれていない場合には、`haveged` などの何らかのエントロピー生成サービスをインストールすることをお勧めします。<sup>Linux 5.6 (March 2020) 版から、投機的実行によるエントロピー生成が含まれるようになりました。</sup>

### 制限事項

アイソレーション型には、プラットフォームとの不整合から生じる制限事項がいくつかあります。最も重大な制限は、Windows 上のサンドボックス化された `<iframes>` 内で外部ファイルが正しく読み込まれないことによるものです。このため、アイソレーション・アプリケーションに関連するスクリプトの内容を取得してインラインに挿入する、ビルド時の簡単なスクリプト・インライン化手順を実装しました。つまりこれは、`<script src="index.js"></script>` のようなファイルの典型的なバンドル、あるいは単純な挿入は依然として正常に機能しますが、ES Modules（ECMAScript Modules）などの新しいメカニズムは上手く読み込ま*ない*ということを意味します。

## 推奨事項

アイソレーション・アプリケーションの目的は開発の脅威から保護することであるため、アイソレーション・アプリケーションはできる限り簡素化しておくことを強くお勧めします。依存関係を最小限に抑えるよう努めるだけでなく、必要なビルド手順を最小限に抑えることも検討する必要があります。これにより、フロントエンド・アプリケーションを覆うアイソレーション・アプリケーションに対するサプライ・チェーン攻撃を心配する必要がなくなります。

## アイソレーション・アプリケーションの作成

次の例では、小さな「hello-world」のようなアイソレーション・アプリケーションを作成し、それを仮に既存の Tauri アプリケーションに接続することを考えます。そこでは、通過するメッセージの検証は行なわれず、WebView コンソールに内容が出力されるだけです。

この事例では、`tauri.conf.json` と同じディレクトリにいると仮定します。既存の Tauri アプリケーションの `distDir` は `../dist` に設定されています。

`../dist-isolation/index.html`:

```html
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Isolation Secure Script</title>
  </head>
  <body>
    <script src="index.js"></script>
  </body>
</html>
```

`../dist-isolation/index.js`:

```javascript
window.__TAURI_ISOLATION_HOOK__ = (payload) => {
  // 何も検証や修正せず、ただ hook から内容を印字するだけです。
  console.log('hook', payload);
  return payload;
};
```

あとは、アイソレーション・パターンを使用するように `tauri.conf.json` の[設定](#設定) を変更し、ブート処理経路を [ブラウンフィールド型] からアイソレーション型に切り替えるだけです。

## 設定

メインのフロントエンド `distDir` が `../dist` に設定されていると仮定します。また、アイソレーション・アプリケーションを `../dist-isolation` に出力します。

```json
{
  "build": {
    "distDir": "../dist"
  },
  "app": {
    "security": {
      "pattern": {
        "use": "isolation",
        "options": {
          "dir": "../dist-isolation"
        }
      }
    }
  }
}
```

[transport_layer_security]: https://ja.wikipedia.org/wiki/Transport_Layer_Security
[セキュリティ：脅威モデル]: ../security/lifecycle/
[events]: ../reference/javascript/api/namespaceevent/
[subtlecrypto]: https://developer.mozilla.org/ja-JP/docs/Web/API/SubtleCrypto
[ブラウンフィールド型]: ../concept/inter-process-communication/brownfield/
[integration testing with webdriver]: ../develop/tests/webdriver/


<div style="text-align:right">
【※ この日本語版は、「Oct 01, 2024 英語版」に基づいています】<br>
Doc-JP 2.00.00
</div>
